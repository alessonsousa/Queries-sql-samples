SELECT 
	SPLETIVO.CODFILIAL,
	SALUNO.RA,
	PPESSOA.NOME	[NOMEDESTINATARIO],
	CASE
	    
		/*REMOVE NÚMEROS FIXOS DA CONSULTA*/
		WHEN 
				(LEN(TELEFONE2) = 8  AND SUBSTRING(TELEFONE2, 1, 1) BETWEEN 2 AND 5) 
			OR  (LEN(TELEFONE2) = 9  AND SUBSTRING(TELEFONE2, 2, 1) BETWEEN 2 AND 5) 
			OR  (LEN(TELEFONE2) = 10 AND SUBSTRING(TELEFONE2, 3, 1) BETWEEN 2 AND 5)
			OR  (LEN(TELEFONE2) = 11 AND SUBSTRING(TELEFONE2, 4, 1) BETWEEN 2 AND 5) 
		THEN NULL
		
		/*ADICIONA 9 APÓS O DDD*/
		WHEN 
				LEN(REPLACE(REPLACE(REPLACE(REPLACE(TELEFONE2, '(', ''), ')', ''), ' ', ''), '-', '')) = 10 
			OR LEN(TELEFONE2) = 10 
		THEN SUBSTRING(REPLACE(REPLACE(REPLACE(REPLACE(TELEFONE2, '(', ''), ')', ''), ' ', ''), '-', ''), 1, 2) 
			 + '9' 
			 + SUBSTRING(REPLACE(REPLACE(REPLACE(REPLACE(TELEFONE2, '(', ''), ')', ''), ' ', ''), '-', ''), 3, 8)
		
		/*PROVAVELMENTE JÁ TEM O 9 APÓS O DDD ENTÃO RETORNA O PRÓPRIO NÚMERO*/
		WHEN 
				LEN(REPLACE(REPLACE(REPLACE(REPLACE(TELEFONE2, '(', ''), ')', ''), ' ', ''), '-', '')) > 10 
		THEN SUBSTRING(REPLACE(REPLACE(REPLACE(REPLACE(TELEFONE2, '(', ''), ')', ''), ' ', ''), '-', ''), 1, 11)
		
		/*REMOVE NÚMEROS SEM DDD*/
		WHEN LEN(REPLACE(REPLACE(REPLACE(REPLACE(TELEFONE2, '(', ''), ')', ''), ' ', ''), '-', '')) < 10 
		  OR LEN(TELEFONE2) < 10 
		THEN NULL		

	END AS 'TELEFONE2'
	 
FROM PPESSOA 

INNER JOIN SALUNO (NOLOCK) ON
	SALUNO.CODPESSOA = PPESSOA.CODIGO

INNER JOIN SMATRICPL (NOLOCK) ON
	SALUNO.RA = SMATRICPL.RA

INNER JOIN SPLETIVO (NOLOCK) ON
	SPLETIVO.IDPERLET = SMATRICPL.IDPERLET
	AND SPLETIVO.CODFILIAL = SMATRICPL.CODFILIAL

INNER JOIN GUSUARIO (NOLOCK) ON
	GUSUARIO.CODUSUARIO = SALUNO.RA

WHERE 
SPLETIVO.CODPERLET = '2021.2'
AND SALUNO.RA IN ('2020210092',
'2021110737',
'2021141027',
'2021141029',
'2021141031',
'2021141033',
'2021141034',
'2021141035',
'2021141037',
'2021141039',
'2021141040',
'2021141041',
'2021141042',
'2021141049',
'2021141051',
'2021141052',
'2021141086',
'2021141111',
'2021141114',
'2021141120',
'2021141133',
'2021141138',
'2021141151',
'2021141272')
GROUP BY PPESSOA.NOME, PPESSOA.TELEFONE2, SPLETIVO.CODFILIAL, SALUNO.RA
